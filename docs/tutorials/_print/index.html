<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<link rel=canonical type=text/html href=https://colearn-dev.github.io/docs/tutorials/>
<link rel=alternate type=application/rss+xml href=https://colearn-dev.github.io/docs/tutorials/index.xml>
<meta name=robots content="noindex, nofollow">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Tutorials | CoLearn</title>
<meta name=description content="Understand how CoLearn accelerate your development and deployment of privacy preserving systems.
">
<meta property="og:title" content="Tutorials">
<meta property="og:description" content="Understand how CoLearn accelerate your development and deployment of privacy preserving systems.
">
<meta property="og:type" content="website">
<meta property="og:url" content="https://colearn-dev.github.io/docs/tutorials/"><meta property="og:site_name" content="CoLearn">
<meta itemprop=name content="Tutorials">
<meta itemprop=description content="Understand how CoLearn accelerate your development and deployment of privacy preserving systems.
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Tutorials">
<meta name=twitter:description content="Understand how CoLearn accelerate your development and deployment of privacy preserving systems.
">
<link rel=preload href=/scss/main.min.704093cd1a56f37fd00dc35c7125fced09d88d60c92d59965b30c8c0eeef1cd5.css as=style>
<link href=/scss/main.min.704093cd1a56f37fd00dc35c7125fced09d88d60c92d59965b30c8c0eeef1cd5.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">CoLearn</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>Blog</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/docs/tutorials/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Tutorials</h1>
<div class=lead>Understand how CoLearn accelerate your development and deployment of privacy preserving systems.</div>
<ul>
<li>1: <a href=#pg-43f9e267ac6e49898314eb682ac41700>1.0 Use Case</a></li>
<li>2: <a href=#pg-9813778a8a1853704e47d725bea183e6>1.1 Naive Simulation</a></li>
<li>3: <a href=#pg-10c7e40fef0d2a9f52bf7b068866b1f5>1.2 Interface</a></li>
<li>4: <a href=#pg-5ec2f361bef14d0c08fc2f19a04489b6>1.3 Server Implementation</a></li>
</ul>
<div class=content>
<p>We introduce a basic secure aggregation protocol here.</p>
</div>
</div>
<div class=td-content>
<h1 id=pg-43f9e267ac6e49898314eb682ac41700>1 - 1.0 Use Case</h1>
<div class=lead>A brief use case of secure aggregation</div>
<p>People fill out online surveys from time to time, and a majority of the surveys claim that they will guarantee <strong>anonymities</strong> to their participants. People also are confident that privacy will not be invaded, since they don&rsquo;t write their names or addresses in the survey. However, their responses are sent to the organizers <strong>intact</strong>, without any processing, along with their IP addresses.</p>
<p>In this tutorial, we propose a privacy-preserving way for servers(survey organizers) and clients(participants) to transfer data to each other. We ensure that the survey organizer receive the overall results of the survey, but not know about each individual questionnaire. To accomplish this goal, we need to make use of <strong>Secure Aggregation protocols</strong>.</p>
<blockquote>
<p><strong>Secure Aggregation protocols</strong> allow a collection of mutually distrust parties, each holding a private value, to collaboratively compute the sum of those values without revealing the values themselves. (<a href=https://research.google/pubs/pub45808/>Source</a>)</p>
</blockquote>
<p>However, secure aggregation protocols need all clients(participants) to be online when the server(survey organizer) is collecting the survey answers. With this condition, we propose the following toy scenario for the tutorial.</p>
<p>University wants to estimate students' pressure by collecting their average sleep time per day. All participants receive the survey on Day 1, and have to fill out the survey with their sleeping time before Day 2. On Day 2, all participants need to tell University their IP addresses. On Day 3, University will collect the results from participants and all participants need to be online this day. University will then use secure aggregation to collect the sum of all participants' sleeping time without sacrificing the privacy of any participant. University can then calculate the average sleeping time by dividing with the participant count.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9813778a8a1853704e47d725bea183e6>2 - 1.1 Naive Simulation</h1>
<p>We begin by discussing one simplest secure aggregation protocol. The protocol is to <strong>add masking values before sending numbers from client (participant) to the server (survey organizer)</strong>. Each pair of users generate a random masking number, and one user adds the number to his value, while the other subtracts the number from his value. When they send their values to the server, the inputs will be random when viewed alone, but summing them up will cancel out the masking values and give the correct summed value.</p>
<p>Let&rsquo;s imagine the university wants to estimate the average hours of sleep its students have everyday, and it presents a survey to students, asking them to fill in the number.</p>
<p>Let&rsquo;s try to simulate with <strong>Rust</strong>, we first take 1000 random sleep hours from range 5 to 12, which means 100 students take the survey, and their answers are uniformly distributed in the range [5, 12].</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>range</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Uniform</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sample_iter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>range</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>take</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_participants</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)).</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Then, to conduct the secure aggregation protocol above, we mask these values before sending them to the server. For each pair of students, we generate a random masking value in range of u32 values.</p>
<p>Notice that we used <code>Wrapping&lt;u32></code> type instead of <code>u32</code> for all values in the code. This is because we want the server to get completely no information from the client, and we need the random number to be taken from the whole range of <code>u32</code>. However, operations like summing two large values might cause overflow in rust. Wrapping u32 up in rust could tolerate overflow to allow modular arithmetic, which enhances the privacy of the client.</p>
<p>We add the value to one student&rsquo;s sleeping time, and then subtract the value from the other&rsquo;s sleeping time. One thing to notice is that each student&rsquo;s sleeping time is masked by <strong>999</strong> masking values since it has a pair with every other student.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>j</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Finally, we are gonna aggregate the masked values as a simulation action for server, and check if the server gets the same aggregate value as simply summing up all unmasked values.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/* Example output
</span><span style=color:#8f5902;font-style:italic>Server Aggregate result: 7978
</span><span style=color:#8f5902;font-style:italic>Naive Aggregate result: 7978
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>Since each client&#39;s initial value is randomly generated, each run of the program may generate different outputs. We only need both results to be same to prove our correctness.
</span><span style=color:#8f5902;font-style:italic>*/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We can see that the aggregate server, without knowing the actual sleeping hours of each student, still get the correct summation of the values, and they can compute the average sleeping time with the value. This is how secure aggregation works.</p>
<h3 id=full-code>Full code</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000;font-weight:700>{</span><span style=color:#000>distributions</span>::<span style=color:#000>Uniform</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rng</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>std</span>::<span style=color:#000>num</span>::<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>range</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Uniform</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sample_iter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>range</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>take</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_participants</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)).</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>j</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-10c7e40fef0d2a9f52bf7b068866b1f5>3 - 1.2 Interface</h1>
<p>In the last chapter, we showed the correctness of the basic secure aggregation protocol. However, in the real world, to support the application that&rsquo;s mentioned in chapter 1.0, we need to use separate servers for different clients and aggregation server.</p>
<p>In this chapter, we first illustrate the interface for both the client and the aggregation server. We will extend it to a real-world network-based solution in the next chapter.</p>
<h3 id=client>Client</h3>
<p>First, let&rsquo;s define a struct called <code>Client</code> , with one field representing the original value it wants to send to the server, one field representing the masked value, and last field representing it&rsquo;s name.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We have 4 functions for the interface of the client:</p>
<ul>
<li>
<p><code>new</code> is used to initialize a new client with a sleeping time passed in as <code>sending_value</code> and a name passed in as <code>name</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sending_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>The aggregation server calls <code>interact_with_others</code> to provide a client with lists of its collaborating clients, and the client will generate a masking value for each of its collaborator, subtract the masking value from the masked value, and call <code>mask_by_adding</code> for each of its collaborators to let them add the masking value to their masked value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>share_value</code> is called for each client when the clients finished masking their values and are ready to share the masked value to the server.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=server>Server</h3>
<p>We also need a struct for <code>Server</code>, with the one field representing the aggregate result, and the other representing the list of all its clients.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>aggregate_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We have two functions for server&rsquo;s interface:</p>
<ul>
<li>
<p><code>initialize</code> tells its clients to prepare for sharing the masked value by calling <code>interact_with_others</code> for each of its client.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>aggregate</code> asks for server&rsquo;s clients to share their masked values, and sums up all the values to get the final aggregate value</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span>:<span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>share_value</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=combine-everything>Combine everything</h3>
<p>Now we have some idea about what servers and clients can do. Let&rsquo;s try to simulate the sleeping-time survey again.</p>
<p>We assume there are 1000 participants (clients), and we initialize 1000 clients with a for loop and initialize a server instance by passing in the vector of clients and initial aggregate value of zero to the server constructor.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Generate all the clients with a for loop.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_name</span>: <span style=color:#204a87>String</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>push</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Generate a server and tells it all the clients we just generated.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span>: <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>aggregate_value</span>:<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>:<span style=color:#000>clients</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Before letting clients process their values, we first aggregate their original values. Then we call <code>initialize</code> of the server which asks each client to mask their values. Finally we print out the server&rsquo;s aggregate value to see if it equals the naive aggregate value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initialize</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/* Example output
</span><span style=color:#8f5902;font-style:italic>Server Aggregate result: 7942
</span><span style=color:#8f5902;font-style:italic>Naive Aggregate result: 7942
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>Since each client&#39;s initial value is randomly generated, each run of the program may generate different outputs. We only need both results to be same to prove our correctness.
</span><span style=color:#8f5902;font-style:italic>*/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>With a clearer interface, the server only gets the masked value from its clients, and each client only knows its own value. We can see that two results are the same. These are the interfaces for clients and the aggregation server to implement secure aggregation.</p>
<h3 id=full-code>Full Code</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000;font-weight:700>{</span><span style=color:#000>distributions</span>::<span style=color:#000>Uniform</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rng</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>std</span>::<span style=color:#000>num</span>::<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sending_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>aggregate_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span>:<span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>share_value</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Generate all the clients with a for loop.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_name</span>: <span style=color:#204a87>String</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>push</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Generate a server and tells it all the clients we just generated.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span>: <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>aggregate_value</span>:<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>:<span style=color:#000>clients</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initialize</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5ec2f361bef14d0c08fc2f19a04489b6>4 - 1.3 Server Implementation</h1>
<p>Now we have a clear abstraction of clients' and server&rsquo;s interfaces. However, in real-world applications, clients and aggregation servers will not reside in one single machine, and thus we need to have a network-based implementation for secure aggregation protocol.</p>
<p><a href=https://docs.rs/warp/latest/warp/>warp</a> is a easy-to-use web server framework for rust. In this chapter we will use warp to implement the servers for both clients and aggregation server. For each server, we will have three modules, which are <strong>filters</strong>, <strong>handlers</strong> and <strong>models</strong>. <strong>Filters</strong> are used to describe endpoints in our web service, and it will pass the requests into <strong>handlers</strong>. Both <strong>filters</strong> and <strong>handlers</strong> might use structs and constructors defined in <strong>models</strong>. To learn more about warp, here are some official <a href=https://github.com/seanmonstar/warp/tree/master/examples>example web servers</a>.</p>
<h3 id=client>Client</h3>
<ul>
<li>
<p>Models</p>
<p>First , we have the struct <code>Client</code> defined the same as the last chapter. On top of that, we have <code>Client_Async</code>, which is the same as <code>Client</code> but supports asynchronous operations. <code>new_Client</code> creates a new Client_Async instance.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Client_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Arc</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Mutex</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new_Client</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#204a87>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Arc</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Mutex</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>)}))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Then we define a new struct, <code>Collaborator_list</code>. It contains a list of collaborating clients' ports and the number of collaborating clients. Remember in last chapter we passed a vector of collaborating clients into <code>interact_with_others</code>. <code>Collaborator_list</code> is for the same purpose.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Deserialize, Serialize)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port_list</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_collaborators</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>Filters and Handlers</p>
<p>The server for client will support three kinds of http requests.</p>
<ul>
<li>
<p>The aggregation server sends a PUT request with a json body parsed as <code>Collaborator_list</code>. It will hit the <code>interact_with_others</code> filter function. The function will catch the request and pass it to the <code>interact_with_others</code> handler function. The handler will do the same thing as <code>interact_with_others</code> does in the last chapter, but instead of calling collaborators' <code>mask_by_adding</code> function, the Client with send another POST request to ask the collaborator to add the masking value to their <code>masked_value</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter PUT /interact
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;interact&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>put</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>body</span>::<span style=color:#000>json</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>collaborator_port_list</span>: <span style=color:#000>Collaborator_list</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>post</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#4e9a06>&#34;http://localhost:{}/maskbyadding/{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Interaction successful&#34;</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter POST /maskbyadding
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;maskbyadding&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>post</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masking_val</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>StatusCode</span>::<span style=color:#000>OK</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>When clients finish masking their values and are ready to share the masked value to the server, the aggregation server will send a GET request to each client&rsquo;s port. The <code>share_val</code> filter function catches the request and passes it to <code>share_val</code> handler.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>//  Filter GET /shareval
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;sharevalue&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>get</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>share_val</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Shared masked val: {}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>Main</p>
<p>Finally, in client&rsquo;s main function, we let our program serve localhost&rsquo;s port 3000+N for the Nth client. A new instance of <code>Client_Async</code> is created by <code>new_Client</code>. This instance will then be used by every filter and handler when processing requests.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[tokio::main]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env</span>::<span style=color:#000>args</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_val</span>: <span style=color:#204a87;font-weight:700>u32</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Let Client #N serve port (3000+N)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u16</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client {} with Value: {}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>models</span>::<span style=color:#000>new_Client</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_val</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>)));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apis</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filters</span>::<span style=color:#000>client_ops</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>apis</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(([</span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>)).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=server>Server</h3>
<ul>
<li>
<p>Models</p>
<p>First, we have a <code>Server</code> struct which has only one field <code>client_ports</code> to record the ports of its clients. Similar as <code>Client</code>, we also have a <code>Server_Async</code> on top of <code>Server</code>. <code>new_Server</code> creates a new server instance with empty <code>client_ports</code> vector. The other struct is <code>Collaborator_list</code> as in the client&rsquo;s models.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_ports</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Server_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Arc</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Mutex</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Server</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new_Server</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Server_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Arc</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Mutex</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>client_ports</span>: <span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>()}))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, Deserialize, Serialize, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port_list</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_collaborators</span>: <span style=color:#204a87;font-weight:700>usize</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>Filters and Handlers</p>
<ul>
<li>
<p><code>Initialize</code> will send PUT requests to each of the clients in the <code>Collaborator_list</code> to call their <code>interact_with_others</code> api. When the server passes <code>Collaborator_list</code> to a client, the server will delete that client from the list so the client doesn&rsquo;t have to collaborate with itself.</p>
<p>The server will also assign its <code>client_ports</code> vector to be the same as <code>port_list</code> in <code>Collabortaor_list</code> for further aggregation.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter PUT /initialize
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;initialize&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>put</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>body</span>::<span style=color:#000>json</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_server</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>initialize</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients_list</span>: <span style=color:#000>Collaborator_list</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server_async</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://localhost:{}/interact&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>json</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#4e9a06>&#34;Initialized Clients: {:#?}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>aggregate_val</code> will send a GET request to each of the client in server&rsquo;s <code>client_ports</code> vector. This will call every client&rsquo;s <code>share_val</code> api and return their masked values. Then the server will sum up all the values to get the final aggregate value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter GET /aggregate
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;aggregate&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>get</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_server</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server_async</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregate_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#4e9a06>&#34;http://localhost:{}/sharevalue&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_val</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>text</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>aggregate_val</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masked_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#4e9a06>&#34;Server Aggregate Result: {} \n&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>aggregate_val</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>Main</p>
<p>In server&rsquo;s main function, we initialize a new instance of <code>Server_Async</code> and pass it to all filters and handlers of the server. Similar to client, we will serve at localhost&rsquo;s (3000+N) port, where N is the input argument to the program.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[tokio::main]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env</span>::<span style=color:#000>args</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;{:?}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>models</span>::<span style=color:#000>new_Server</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apis</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filters</span>::<span style=color:#000>server_ops</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Let Server serve port (3000+N)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>apis</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(([</span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u16</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>()))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=demo>Demo</h3>
<p>Different from last two chapters, we will have to run multiple programs to test the correctness of our code.</p>
<ul>
<li>
<p><strong>Step 1: Create clients</strong></p>
<p>For convenience, let&rsquo;s just create 5 clients. Open five different terminals and run the following commands one by one, which will create 5 clients listening on localhost&rsquo;s port 3001, 3002, 3003, 3004, and 3005. Their actual values will also be printed in the terminal so you can sum them up by hand.</p>
<pre tabindex=0><code>cargo run --bin client 1
cargo run --bin client 2
cargo run --bin client 3
cargo run --bin client 4
cargo run --bin client 5
</code></pre></li>
<li>
<p><strong>Step 2: Create a server</strong></p>
<p>Then we are gonna need a server. Open another terminal and run the following command, which will create a server listening on port 3100.</p>
<pre tabindex=0><code>cargo run --bin server 100
</code></pre></li>
<li>
<p><strong>Step 3: Initialize and check the aggregate result</strong></p>
<p>We are gonna use curl to send http requests.</p>
<pre tabindex=0><code>curl -X PUT -H &quot;Content-Type: application/json&quot; -d '{&quot;port_list&quot;:[3001,3002,3003,3004,3005], &quot;num_collaborators&quot;:5}' http://localhost:3100/initialize

curl http://localhost:3100/aggregate
</code></pre><p>and you will see the result. Compare them to the sum of initial values, and we will see they are the same</p>
</li>
</ul>
<h3 id=full-code>Full Code</h3>
<p>View at <a href=https://github.com/camelop/dds-dev/tree/tutorial/chapter1.3>Github</a></p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://example.org/mail aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel=noopener href=https://example.org/twitter aria-label=Twitter>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel=noopener href=https://example.org/stack aria-label="Stack Overflow">
<i class="fab fa-stack-overflow"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/google/docsy aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://example.org/slack aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://example.org/mail aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small>
<p class=mt-2><a href=/about/>About CoLearn</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.9527cedfef7fd2d44b9f7e019d1d3f20914d42e1280da7342a1a7facd3249a54.js integrity="sha256-lSfO3+9/0tRLn34BnR0/IJFNQuEoDac0Khp/rNMkmlQ=" crossorigin=anonymous></script>
</body>
</html>