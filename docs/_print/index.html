<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<link rel=canonical type=text/html href=https://colearn-dev.github.io/docs/>
<link rel=alternate type=application/rss+xml href=https://colearn-dev.github.io/docs/index.xml>
<meta name=robots content="noindex, nofollow">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Documentation | CoLearn</title>
<meta name=description content="Data collaboration is a common need in many research fields including finance, health care, cybersecurity, and many others. To protect data privacy in …">
<meta property="og:title" content="Documentation">
<meta property="og:description" content="A secure tool for data collaboration">
<meta property="og:type" content="website">
<meta property="og:url" content="https://colearn-dev.github.io/docs/"><meta property="og:site_name" content="CoLearn">
<meta itemprop=name content="Documentation">
<meta itemprop=description content="A secure tool for data collaboration"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Documentation">
<meta name=twitter:description content="A secure tool for data collaboration">
<link rel=preload href=/scss/main.min.704093cd1a56f37fd00dc35c7125fced09d88d60c92d59965b30c8c0eeef1cd5.css as=style>
<link href=/scss/main.min.704093cd1a56f37fd00dc35c7125fced09d88d60c92d59965b30c8c0eeef1cd5.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">CoLearn</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>Blog</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/docs/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Documentation</h1>
<ul>
<li>1: <a href=#pg-93aadc1aba179e6928539400a09b9e4e>Getting Started</a></li>
<ul>
<li>1.1: <a href=#pg-19910e17d662389a54e0e81ecab73994>Example Page</a></li>
</ul>
<li>2: <a href=#pg-fb0f854c53f1ba28ad4c2ccf8d24df34>Examples</a></li>
<ul>
</ul>
<li>3: <a href=#pg-8dbd4e302cd86a4d0f71f71ce3b300de>Tutorials</a></li>
<ul>
<li>3.1: <a href=#pg-43f9e267ac6e49898314eb682ac41700>1.0 Use Case</a></li>
<li>3.2: <a href=#pg-9813778a8a1853704e47d725bea183e6>1.1 Naive Simulation</a></li>
<li>3.3: <a href=#pg-10c7e40fef0d2a9f52bf7b068866b1f5>1.2 Interface</a></li>
<li>3.4: <a href=#pg-5ec2f361bef14d0c08fc2f19a04489b6>1.3 Server Implementation</a></li>
</ul>
<li>4: <a href=#pg-b8e75a52eff53776993479c317c1e4ff>gRPC Service Specification</a></li>
<ul>
</ul>
</ul>
<div class=content>
<p>Data collaboration is a common need in many research fields including finance, health care, cybersecurity, and many others. To protect data privacy in such collaborations, techniques like federated analytics, federated learning, and privacy-preserving machine learning are proposed. However, because there is no universal framework that provides a consistent data collaboration workflow, the implementation and deployment of these techniques in real-world applications are often challenging. Due to the difference in storage and computation abstractions, it is also hard to combine techniques in different works together to provide better solutions.</p>
<p>In this work, we plan to investigate an efficient programming abstraction to support decentralized data science. We plan to design a framework that handles storage, communication and provides multi-party data collaboration abstractions. Extending gRPC, we propose to simplify the development of multi-party protocols and allow implementations in different programming languages to work together under a consistent interface. With a unified interface that increases potential data contributors, our framework has the potential to enable larger-scale decentralized data collaboration and unlock the true value of data.</p>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-93aadc1aba179e6928539400a09b9e4e>1 - Getting Started</h1>
<div class=lead>What does your user need to know to try your project?</div>
<div class="pageinfo pageinfo-primary">
<p>This is a placeholder page that shows you how to use this template site.</p>
</div>
<p>Information in this section helps your user try your project themselves.</p>
<ul>
<li>
<p>What do your users need to do to start using your project? This could include downloading/installation instructions, including any prerequisites or system requirements.</p>
</li>
<li>
<p>Introductory “Hello World” example, if appropriate. More complex tutorials should live in the Tutorials section.</p>
</li>
</ul>
<p>Consider using the headings below for your getting started page. You can delete any that are not applicable to your project.</p>
<h2 id=prerequisites>Prerequisites</h2>
<p>Are there any system requirements for using your project? What languages are supported (if any)? Do users need to already have any software or tools installed?</p>
<h2 id=installation>Installation</h2>
<p>Where can your user find your project code? How can they install it (binaries, installable package, build from source)? Are there multiple options/versions they can install and how should they choose the right one for them?</p>
<h2 id=setup>Setup</h2>
<p>Is there any initial setup users need to do after installation to try your project?</p>
<h2 id=try-it-out>Try it out!</h2>
<p>Can your users test their installation, for example by running a command or deploying a Hello World example?</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-19910e17d662389a54e0e81ecab73994>1.1 - Example Page</h1>
<div class=lead>A short lead description about this content page. It can be <strong>bold</strong> or <em>italic</em> and can be split over multiple paragraphs.</div>
<div class="pageinfo pageinfo-primary">
<p>This is a placeholder page. Replace it with your own content.</p>
</div>
<p>Text can be <strong>bold</strong>, <em>italic</em>, or <del>strikethrough</del>. <a href=https://gohugo.io>Links</a> should be blue with no underlines (unless hovered over).</p>
<p>There should be whitespace between paragraphs. Vape migas chillwave sriracha poutine try-hard distillery. Tattooed shabby chic small batch, pabst art party heirloom letterpress air plant pop-up. Sustainable chia skateboard art party banjo cardigan normcore affogato vexillologist quinoa meggings man bun master cleanse shoreditch readymade. Yuccie prism four dollar toast tbh cardigan iPhone, tumblr listicle live-edge VHS. Pug lyft normcore hot chicken biodiesel, actually keffiyeh thundercats photo booth pour-over twee fam food truck microdosing banh mi. Vice activated charcoal raclette unicorn live-edge post-ironic. Heirloom vexillologist coloring book, beard deep v letterpress echo park humblebrag tilde.</p>
<p>90&rsquo;s four loko seitan photo booth gochujang freegan tumeric listicle fam ugh humblebrag. Bespoke leggings gastropub, biodiesel brunch pug fashion axe meh swag art party neutra deep v chia. Enamel pin fanny pack knausgaard tofu, artisan cronut hammock meditation occupy master cleanse chartreuse lumbersexual. Kombucha kogi viral truffaut synth distillery single-origin coffee ugh slow-carb marfa selfies. Pitchfork schlitz semiotics fanny pack, ugh artisan vegan vaporware hexagon. Polaroid fixie post-ironic venmo wolf ramps <strong>kale chips</strong>.</p>
<blockquote>
<p>There should be no margin above this first sentence.</p>
<p>Blockquotes should be a lighter gray with a border along the left side in the secondary color.</p>
<p>There should be no margin below this final sentence.</p>
</blockquote>
<h2 id=first-header-2>First Header 2</h2>
<p>This is a normal paragraph following a header. Knausgaard kale chips snackwave microdosing cronut copper mug swag synth bitters letterpress glossier <strong>craft beer</strong>. Mumblecore bushwick authentic gochujang vegan chambray meditation jean shorts irony. Viral farm-to-table kale chips, pork belly palo santo distillery activated charcoal aesthetic jianbing air plant woke lomo VHS organic. Tattooed locavore succulents heirloom, small batch sriracha echo park DIY af. Shaman you probably haven&rsquo;t heard of them copper mug, crucifix green juice vape <em>single-origin coffee</em> brunch actually. Mustache etsy vexillologist raclette authentic fam. Tousled beard humblebrag asymmetrical. I love turkey, I love my job, I love my friends, I love Chardonnay!</p>
<p>Deae legum paulatimque terra, non vos mutata tacet: dic. Vocant docuique me plumas fila quin afuerunt copia haec o neque.</p>
<p>On big screens, paragraphs and headings should not take up the full container width, but we want tables, code blocks and similar to take the full width.</p>
<p>Scenester tumeric pickled, authentic crucifix post-ironic fam freegan VHS pork belly 8-bit yuccie PBR&B. <strong>I love this life we live in</strong>.</p>
<h2 id=second-header-2>Second Header 2</h2>
<blockquote>
<p>This is a blockquote following a header. Bacon ipsum dolor sit amet t-bone doner shank drumstick, pork belly porchetta chuck sausage brisket ham hock rump pig. Chuck kielbasa leberkas, pork bresaola ham hock filet mignon cow shoulder short ribs biltong.</p>
</blockquote>
<h3 id=header-3>Header 3</h3>
<pre tabindex=0><code>This is a code block following a header.
</code></pre><p>Next level leggings before they sold out, PBR&B church-key shaman echo park. Kale chips occupy godard whatever pop-up freegan pork belly selfies. Gastropub Belinda subway tile woke post-ironic seitan. Shabby chic man bun semiotics vape, chia messenger bag plaid cardigan.</p>
<h4 id=header-4>Header 4</h4>
<ul>
<li>This is an unordered list following a header.</li>
<li>This is an unordered list following a header.</li>
<li>This is an unordered list following a header.</li>
</ul>
<h5 id=header-5>Header 5</h5>
<ol>
<li>This is an ordered list following a header.</li>
<li>This is an ordered list following a header.</li>
<li>This is an ordered list following a header.</li>
</ol>
<h6 id=header-6>Header 6</h6>
<table>
<thead>
<tr>
<th>What</th>
<th>Follows</th>
</tr>
</thead>
<tbody>
<tr>
<td>A table</td>
<td>A header</td>
</tr>
<tr>
<td>A table</td>
<td>A header</td>
</tr>
<tr>
<td>A table</td>
<td>A header</td>
</tr>
</tbody>
</table>
<hr>
<p>There&rsquo;s a horizontal rule above and below this.</p>
<hr>
<p>Here is an unordered list:</p>
<ul>
<li>Liverpool F.C.</li>
<li>Chelsea F.C.</li>
<li>Manchester United F.C.</li>
</ul>
<p>And an ordered list:</p>
<ol>
<li>Michael Brecker</li>
<li>Seamus Blake</li>
<li>Branford Marsalis</li>
</ol>
<p>And an unordered task list:</p>
<ul>
<li><input checked disabled type=checkbox> Create a Hugo theme</li>
<li><input checked disabled type=checkbox> Add task lists to it</li>
<li><input disabled type=checkbox> Take a vacation</li>
</ul>
<p>And a &ldquo;mixed&rdquo; task list:</p>
<ul>
<li><input disabled type=checkbox> Pack bags</li>
<li>?</li>
<li><input disabled type=checkbox> Travel!</li>
</ul>
<p>And a nested list:</p>
<ul>
<li>Jackson 5
<ul>
<li>Michael</li>
<li>Tito</li>
<li>Jackie</li>
<li>Marlon</li>
<li>Jermaine</li>
</ul>
</li>
<li>TMNT
<ul>
<li>Leonardo</li>
<li>Michelangelo</li>
<li>Donatello</li>
<li>Raphael</li>
</ul>
</li>
</ul>
<p>Definition lists can be used with Markdown syntax. Definition headers are bold.</p>
<dl>
<dt>Name</dt>
<dd>Godzilla</dd>
<dt>Born</dt>
<dd>1952</dd>
<dt>Birthplace</dt>
<dd>Japan</dd>
<dt>Color</dt>
<dd>Green</dd>
</dl>
<hr>
<p>Tables should have bold headings and alternating shaded rows.</p>
<table>
<thead>
<tr>
<th>Artist</th>
<th>Album</th>
<th>Year</th>
</tr>
</thead>
<tbody>
<tr>
<td>Michael Jackson</td>
<td>Thriller</td>
<td>1982</td>
</tr>
<tr>
<td>Prince</td>
<td>Purple Rain</td>
<td>1984</td>
</tr>
<tr>
<td>Beastie Boys</td>
<td>License to Ill</td>
<td>1986</td>
</tr>
</tbody>
</table>
<p>If a table is too wide, it should scroll horizontally.</p>
<table>
<thead>
<tr>
<th>Artist</th>
<th>Album</th>
<th>Year</th>
<th>Label</th>
<th>Awards</th>
<th>Songs</th>
</tr>
</thead>
<tbody>
<tr>
<td>Michael Jackson</td>
<td>Thriller</td>
<td>1982</td>
<td>Epic Records</td>
<td>Grammy Award for Album of the Year, American Music Award for Favorite Pop/Rock Album, American Music Award for Favorite Soul/R&B Album, Brit Award for Best Selling Album, Grammy Award for Best Engineered Album, Non-Classical</td>
<td>Wanna Be Startin' Somethin', Baby Be Mine, The Girl Is Mine, Thriller, Beat It, Billie Jean, Human Nature, P.Y.T. (Pretty Young Thing), The Lady in My Life</td>
</tr>
<tr>
<td>Prince</td>
<td>Purple Rain</td>
<td>1984</td>
<td>Warner Brothers Records</td>
<td>Grammy Award for Best Score Soundtrack for Visual Media, American Music Award for Favorite Pop/Rock Album, American Music Award for Favorite Soul/R&B Album, Brit Award for Best Soundtrack/Cast Recording, Grammy Award for Best Rock Performance by a Duo or Group with Vocal</td>
<td>Let&rsquo;s Go Crazy, Take Me With U, The Beautiful Ones, Computer Blue, Darling Nikki, When Doves Cry, I Would Die 4 U, Baby I&rsquo;m a Star, Purple Rain</td>
</tr>
<tr>
<td>Beastie Boys</td>
<td>License to Ill</td>
<td>1986</td>
<td>Mercury Records</td>
<td>noawardsbutthistablecelliswide</td>
<td>Rhymin & Stealin, The New Style, She&rsquo;s Crafty, Posse in Effect, Slow Ride, Girls, (You Gotta) Fight for Your Right, No Sleep Till Brooklyn, Paul Revere, Hold It Now, Hit It, Brass Monkey, Slow and Low, Time to Get Ill</td>
</tr>
</tbody>
</table>
<hr>
<p>Code snippets like <code>var foo = "bar";</code> can be shown inline.</p>
<p>Also, <code>this should vertically align</code> <del><code>with this</code></del> <del>and this</del>.</p>
<p>Code can also be shown in a block element.</p>
<pre tabindex=0><code>foo := &quot;bar&quot;;
bar := &quot;foo&quot;;
</code></pre><p>Code can also use syntax highlighting.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#4e9a06>`var foo = &#34;bar&#34;;`</span>

  <span style=color:#000>lexer</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>lexers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;javascript&#34;</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#000>iterator</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>lexer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tokenise</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>input</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#000>style</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>styles</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;github&#34;</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#000>formatter</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>html</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithLineNumbers</span><span style=color:#000;font-weight:700>())</span>

  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>buff</span> <span style=color:#000>bytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Buffer</span>
  <span style=color:#000>formatter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Format</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>buff</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>style</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>iterator</span><span style=color:#000;font-weight:700>)</span>

  <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buff</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>())</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><pre tabindex=0><code>Long, single-line code blocks should not wrap. They should horizontally scroll if they are too long. This line should be long enough to demonstrate this.
</code></pre><p>Inline code inside table cells should still be distinguishable.</p>
<table>
<thead>
<tr>
<th>Language</th>
<th>Code</th>
</tr>
</thead>
<tbody>
<tr>
<td>Javascript</td>
<td><code>var foo = "bar";</code></td>
</tr>
<tr>
<td>Ruby</td>
<td><code>foo = "bar"{</code></td>
</tr>
</tbody>
</table>
<hr>
<p>Small images should be shown at their actual size.</p>
<p><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Picea_abies_shoot_with_buds%2C_Sogndal%2C_Norway.jpg/240px-Picea_abies_shoot_with_buds%2C_Sogndal%2C_Norway.jpg alt></p>
<p>Large images should always scale down and fit in the content container.</p>
<p><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Picea_abies_shoot_with_buds%2C_Sogndal%2C_Norway.jpg/1024px-Picea_abies_shoot_with_buds%2C_Sogndal%2C_Norway.jpg alt></p>
<p><em>The photo above of the Spruce Picea abies shoot with foliage buds: Bjørn Erik Pedersen, CC-BY-SA.</em></p>
<h2 id=components>Components</h2>
<h3 id=alerts>Alerts</h3>
<p>
<div class="alert alert-primary" role=alert>
This is an alert.
</div>
<div class="alert alert-primary" role=alert>
<h4 class=alert-heading>Note</h4>
This is an alert with a title.
</div>
<div class="alert alert-primary" role=alert>
<h4 class=alert-heading>Note</h4>
This is an alert with a title and <strong>Markdown</strong>.
</div>
<div class="alert alert-success" role=alert>
This is a successful alert.
</div>
<div class="alert alert-warning" role=alert>
This is a warning.
</div>
<div class="alert alert-warning" role=alert>
<h4 class=alert-heading>Warning</h4>
This is a warning with a title.
</div>
</p>
<h2 id=another-heading>Another Heading</h2>
<p>Add some sections here to see how the ToC looks like. Bacon ipsum dolor sit amet t-bone doner shank drumstick, pork belly porchetta chuck sausage brisket ham hock rump pig. Chuck kielbasa leberkas, pork bresaola ham hock filet mignon cow shoulder short ribs biltong.</p>
<h3 id=this-document>This Document</h3>
<p>Inguina genus: Anaphen post: lingua violente voce suae meus aetate diversi. Orbis unam nec flammaeque status deam Silenum erat et a ferrea. Excitus rigidum ait: vestro et Herculis convicia: nitidae deseruit coniuge Proteaque adiciam <em>eripitur</em>? Sitim noceat signa <em>probat quidem</em>. Sua longis <em>fugatis</em> quidem genae.</p>
<h3 id=pixel-count>Pixel Count</h3>
<p>Tilde photo booth wayfarers cliche lomo intelligentsia man braid kombucha vaporware farm-to-table mixtape portland. PBR&B pickled cornhole ugh try-hard ethical subway tile. Fixie paleo intelligentsia pabst. Ennui waistcoat vinyl gochujang. Poutine salvia authentic affogato, chambray lumbersexual shabby chic.</p>
<h3 id=contact-info>Contact Info</h3>
<p>Plaid hell of cred microdosing, succulents tilde pour-over. Offal shabby chic 3 wolf moon blue bottle raw denim normcore poutine pork belly.</p>
<h3 id=external-links>External Links</h3>
<p>Stumptown PBR&B keytar plaid street art, forage XOXO pitchfork selvage affogato green juice listicle pickled everyday carry hashtag. Organic sustainable letterpress sartorial scenester intelligentsia swag bushwick. Put a bird on it stumptown neutra locavore. IPhone typewriter messenger bag narwhal. Ennui cold-pressed seitan flannel keytar, single-origin coffee adaptogen occupy yuccie williamsburg chillwave shoreditch forage waistcoat.</p>
<pre tabindex=0><code>This is the final element on the page and there should be no margin below this.
</code></pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fb0f854c53f1ba28ad4c2ccf8d24df34>2 - Examples</h1>
<div class=lead>See some examples of using DDS!</div>
<h2 id=client>Client</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Serialize, Deserialize, Debug)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>GreetingsParam</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>message</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[tokio::main]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Box</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>dyn</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>std</span>::<span style=color:#000>error</span>::<span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env</span>::<span style=color:#000>args</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>skip</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>collect</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>addr</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>args</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dds</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Dds</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>addr</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dds</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#4e9a06>&#34;greetings&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>bincode</span>::<span style=color:#000>serialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>GreetingsParam</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000>message</span>: <span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>})</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>vec!</span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.1.1:50051&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initiator&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>()),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.1.2:50051&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;receiver&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>()),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.1.3:50051&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;receiver&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>to_string</span><span style=color:#000;font-weight:700>()),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;ID={}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>task_id</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8dbd4e302cd86a4d0f71f71ce3b300de>3 - Tutorials</h1>
<div class=lead>Understand how CoLearn accelerate your development and deployment of privacy preserving systems.</div>
<p>We introduce a basic secure aggregation protocol here.</p>
</div>
<div class=td-content>
<h1 id=pg-43f9e267ac6e49898314eb682ac41700>3.1 - 1.0 Use Case</h1>
<div class=lead>A brief use case of secure aggregation</div>
<p>People fill out online surveys from time to time, and a majority of the surveys claim that they will guarantee <strong>anonymities</strong> to their participants. People also are confident that privacy will not be invaded, since they don&rsquo;t write their names or addresses in the survey. However, their responses are sent to the organizers <strong>intact</strong>, without any processing, along with their IP addresses.</p>
<p>In this tutorial, we propose a privacy-preserving way for servers(survey organizers) and clients(participants) to transfer data to each other. We ensure that the survey organizer receive the overall results of the survey, but not know about each individual questionnaire. To accomplish this goal, we need to make use of <strong>Secure Aggregation protocols</strong>.</p>
<blockquote>
<p><strong>Secure Aggregation protocols</strong> allow a collection of mutually distrust parties, each holding a private value, to collaboratively compute the sum of those values without revealing the values themselves. (<a href=https://research.google/pubs/pub45808/>Source</a>)</p>
</blockquote>
<p>However, secure aggregation protocols need all clients(participants) to be online when the server(survey organizer) is collecting the survey answers. With this condition, we propose the following toy scenario for the tutorial.</p>
<p>University wants to estimate students' pressure by collecting their average sleep time per day. All participants receive the survey on Day 1, and have to fill out the survey with their sleeping time before Day 2. On Day 2, all participants need to tell University their IP addresses. On Day 3, University will collect the results from participants and all participants need to be online this day. University will then use secure aggregation to collect the sum of all participants' sleeping time without sacrificing the privacy of any participant. University can then calculate the average sleeping time by dividing with the participant count.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9813778a8a1853704e47d725bea183e6>3.2 - 1.1 Naive Simulation</h1>
<p>We begin by discussing one simplest secure aggregation protocol. The protocol is to <strong>add masking values before sending numbers from client (participant) to the server (survey organizer)</strong>. Each pair of users generate a random masking number, and one user adds the number to his value, while the other subtracts the number from his value. When they send their values to the server, the inputs will be random when viewed alone, but summing them up will cancel out the masking values and give the correct summed value.</p>
<p>Let&rsquo;s imagine the university wants to estimate the average hours of sleep its students have everyday, and it presents a survey to students, asking them to fill in the number.</p>
<p>Let&rsquo;s try to simulate with <strong>Rust</strong>, we first take 1000 random sleep hours from range 5 to 12, which means 100 students take the survey, and their answers are uniformly distributed in the range [5, 12].</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>range</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Uniform</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sample_iter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>range</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>take</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_participants</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)).</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Then, to conduct the secure aggregation protocol above, we mask these values before sending them to the server. For each pair of students, we generate a random masking value in range of u32 values.</p>
<p>Notice that we used <code>Wrapping&lt;u32></code> type instead of <code>u32</code> for all values in the code. This is because we want the server to get completely no information from the client, and we need the random number to be taken from the whole range of <code>u32</code>. However, operations like summing two large values might cause overflow in rust. Wrapping u32 up in rust could tolerate overflow to allow modular arithmetic, which enhances the privacy of the client.</p>
<p>We add the value to one student&rsquo;s sleeping time, and then subtract the value from the other&rsquo;s sleeping time. One thing to notice is that each student&rsquo;s sleeping time is masked by <strong>999</strong> masking values since it has a pair with every other student.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>j</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Finally, we are gonna aggregate the masked values as a simulation action for server, and check if the server gets the same aggregate value as simply summing up all unmasked values.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/* Example output
</span><span style=color:#8f5902;font-style:italic>Server Aggregate result: 7978
</span><span style=color:#8f5902;font-style:italic>Naive Aggregate result: 7978
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>Since each client&#39;s initial value is randomly generated, each run of the program may generate different outputs. We only need both results to be same to prove our correctness.
</span><span style=color:#8f5902;font-style:italic>*/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We can see that the aggregate server, without knowing the actual sleeping hours of each student, still get the correct summation of the values, and they can compute the average sleeping time with the value. This is how secure aggregation works.</p>
<h3 id=full-code>Full code</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000;font-weight:700>{</span><span style=color:#000>distributions</span>::<span style=color:#000>Uniform</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rng</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>std</span>::<span style=color:#000>num</span>::<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>range</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Uniform</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sample_iter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>range</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>take</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>num_participants</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)).</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>j</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_vals</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-10c7e40fef0d2a9f52bf7b068866b1f5>3.3 - 1.2 Interface</h1>
<p>In the last chapter, we showed the correctness of the basic secure aggregation protocol. However, in the real world, to support the application that&rsquo;s mentioned in chapter 1.0, we need to use separate servers for different clients and aggregation server.</p>
<p>In this chapter, we first illustrate the interface for both the client and the aggregation server. We will extend it to a real-world network-based solution in the next chapter.</p>
<h3 id=client>Client</h3>
<p>First, let&rsquo;s define a struct called <code>Client</code> , with one field representing the original value it wants to send to the server, one field representing the masked value, and last field representing it&rsquo;s name.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We have 4 functions for the interface of the client:</p>
<ul>
<li>
<p><code>new</code> is used to initialize a new client with a sleeping time passed in as <code>sending_value</code> and a name passed in as <code>name</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sending_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>The aggregation server calls <code>interact_with_others</code> to provide a client with lists of its collaborating clients, and the client will generate a masking value for each of its collaborator, subtract the masking value from the masked value, and call <code>mask_by_adding</code> for each of its collaborators to let them add the masking value to their masked value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>share_value</code> is called for each client when the clients finished masking their values and are ready to share the masked value to the server.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=server>Server</h3>
<p>We also need a struct for <code>Server</code>, with the one field representing the aggregate result, and the other representing the list of all its clients.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>aggregate_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We have two functions for server&rsquo;s interface:</p>
<ul>
<li>
<p><code>initialize</code> tells its clients to prepare for sharing the masked value by calling <code>interact_with_others</code> for each of its client.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>aggregate</code> asks for server&rsquo;s clients to share their masked values, and sums up all the values to get the final aggregate value</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span>:<span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>share_value</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=combine-everything>Combine everything</h3>
<p>Now we have some idea about what servers and clients can do. Let&rsquo;s try to simulate the sleeping-time survey again.</p>
<p>We assume there are 1000 participants (clients), and we initialize 1000 clients with a for loop and initialize a server instance by passing in the vector of clients and initial aggregate value of zero to the server constructor.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Generate all the clients with a for loop.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_name</span>: <span style=color:#204a87>String</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>push</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Generate a server and tells it all the clients we just generated.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span>: <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>aggregate_value</span>:<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>:<span style=color:#000>clients</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Before letting clients process their values, we first aggregate their original values. Then we call <code>initialize</code> of the server which asks each client to mask their values. Finally we print out the server&rsquo;s aggregate value to see if it equals the naive aggregate value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initialize</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/* Example output
</span><span style=color:#8f5902;font-style:italic>Server Aggregate result: 7942
</span><span style=color:#8f5902;font-style:italic>Naive Aggregate result: 7942
</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>Since each client&#39;s initial value is randomly generated, each run of the program may generate different outputs. We only need both results to be same to prove our correctness.
</span><span style=color:#8f5902;font-style:italic>*/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>With a clearer interface, the server only gets the masked value from its clients, and each client only knows its own value. We can see that two results are the same. These are the interfaces for clients and the aggregation server to implement secure aggregation.</p>
<h3 id=full-code>Full Code</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000;font-weight:700>{</span><span style=color:#000>distributions</span>::<span style=color:#000>Uniform</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Rng</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>std</span>::<span style=color:#000>num</span>::<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sending_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other_clients</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>aggregate_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>current_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span>:<span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>share_value</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate_value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Generate all the clients with a for loop.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>num_participants</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_name</span>: <span style=color:#204a87>String</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>push</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Generate a server and tells it all the clients we just generated.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span>: <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>aggregate_value</span>:<span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients</span>:<span style=color:#000>clients</span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clients</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>sum</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Naive Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>naive_aggregate</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initialize</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Server Aggregate result: {:.2}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>aggregate</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5ec2f361bef14d0c08fc2f19a04489b6>3.4 - 1.3 Server Implementation</h1>
<p>Now we have a clear abstraction of clients' and server&rsquo;s interfaces. However, in real-world applications, clients and aggregation servers will not reside in one single machine, and thus we need to have a network-based implementation for secure aggregation protocol.</p>
<p><a href=https://docs.rs/warp/latest/warp/>warp</a> is a easy-to-use web server framework for rust. In this chapter we will use warp to implement the servers for both clients and aggregation server. For each server, we will have three modules, which are <strong>filters</strong>, <strong>handlers</strong> and <strong>models</strong>. <strong>Filters</strong> are used to describe endpoints in our web service, and it will pass the requests into <strong>handlers</strong>. Both <strong>filters</strong> and <strong>handlers</strong> might use structs and constructors defined in <strong>models</strong>. To learn more about warp, here are some official <a href=https://github.com/seanmonstar/warp/tree/master/examples>example web servers</a>.</p>
<h3 id=client>Client</h3>
<ul>
<li>
<p>Models</p>
<p>First , we have the struct <code>Client</code> defined the same as the last chapter. On top of that, we have <code>Client_Async</code>, which is the same as <code>Client</code> but supports asynchronous operations. <code>new_Client</code> creates a new Client_Async instance.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>: <span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Client_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Arc</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Mutex</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Client</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new_Client</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#204a87>String</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Client_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Arc</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Mutex</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>value</span>: <span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span>:<span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_value</span>: <span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sending_value</span><span style=color:#000;font-weight:700>)}))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Then we define a new struct, <code>Collaborator_list</code>. It contains a list of collaborating clients' ports and the number of collaborating clients. Remember in last chapter we passed a vector of collaborating clients into <code>interact_with_others</code>. <code>Collaborator_list</code> is for the same purpose.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Deserialize, Serialize)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port_list</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_collaborators</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>Filters and Handlers</p>
<p>The server for client will support three kinds of http requests.</p>
<ul>
<li>
<p>The aggregation server sends a PUT request with a json body parsed as <code>Collaborator_list</code>. It will hit the <code>interact_with_others</code> filter function. The function will catch the request and pass it to the <code>interact_with_others</code> handler function. The handler will do the same thing as <code>interact_with_others</code> does in the last chapter, but instead of calling collaborators' <code>mask_by_adding</code> function, the Client with send another POST request to ask the collaborator to add the masking value to their <code>masked_value</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter PUT /interact
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;interact&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>put</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>body</span>::<span style=color:#000>json</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>interact_with_others</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>collaborator_port_list</span>: <span style=color:#000>Collaborator_list</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_collaborator</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>post</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#4e9a06>&#34;http://localhost:{}/maskbyadding/{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000>curr_collaborator</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masking_val</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Interaction successful&#34;</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter POST /maskbyadding
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;maskbyadding&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>post</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>mask_by_adding</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>masking_val</span>: <span style=color:#204a87;font-weight:700>u32</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masking_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>StatusCode</span>::<span style=color:#000>OK</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>When clients finish masking their values and are ready to share the masked value to the server, the aggregation server will send a GET request to each client&rsquo;s port. The <code>share_val</code> filter function catches the request and passes it to <code>share_val</code> handler.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>//  Filter GET /shareval
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>client</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;sharevalue&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>get</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_client</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>share_val</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>share_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_async</span>: <span style=color:#000>Client_Async</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Shared masked val: {}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>masked_value</span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>Main</p>
<p>Finally, in client&rsquo;s main function, we let our program serve localhost&rsquo;s port 3000+N for the Nth client. A new instance of <code>Client_Async</code> is created by <code>new_Client</code>. This instance will then be used by every filter and handler when processing requests.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[tokio::main]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env</span>::<span style=color:#000>args</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_val</span>: <span style=color:#204a87;font-weight:700>u32</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rand</span>::<span style=color:#000>thread_rng</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>gen_range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Let Client #N serve port (3000+N)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u16</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client {} with Value: {}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>models</span>::<span style=color:#000>new_Client</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client_val</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>String</span>::<span style=color:#000>from</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Client #{}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>)));</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apis</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filters</span>::<span style=color:#000>client_ops</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>apis</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(([</span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port</span><span style=color:#000;font-weight:700>)).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=server>Server</h3>
<ul>
<li>
<p>Models</p>
<p>First, we have a <code>Server</code> struct which has only one field <code>client_ports</code> to record the ports of its clients. Similar as <code>Client</code>, we also have a <code>Server_Async</code> on top of <code>Server</code>. <code>new_Server</code> creates a new server instance with empty <code>client_ports</code> vector. The other struct is <code>Collaborator_list</code> as in the client&rsquo;s models.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[derive(Debug, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client_ports</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Server_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Arc</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Mutex</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Server</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new_Server</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Server_Async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Arc</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Mutex</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#000>client_ports</span>: <span style=color:#204a87>Vec</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>()}))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(Debug, Deserialize, Serialize, Clone)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>port_list</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num_collaborators</span>: <span style=color:#204a87;font-weight:700>usize</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>Filters and Handlers</p>
<ul>
<li>
<p><code>Initialize</code> will send PUT requests to each of the clients in the <code>Collaborator_list</code> to call their <code>interact_with_others</code> api. When the server passes <code>Collaborator_list</code> to a client, the server will delete that client from the list so the client doesn&rsquo;t have to collaborate with itself.</p>
<p>The server will also assign its <code>client_ports</code> vector to be the same as <code>port_list</code> in <code>Collabortaor_list</code> for further aggregation.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter PUT /initialize
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;initialize&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>put</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>body</span>::<span style=color:#000>json</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_server</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>initialize</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>initialize</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>clients_list</span>: <span style=color:#000>Collaborator_list</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server_async</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_list</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clients_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://localhost:{}/interact&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>json</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>insert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>curr_client</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>num_collaborators</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#4e9a06>&#34;Initialized Clients: {:#?}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>collaborator_list</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>port_list</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p><code>aggregate_val</code> will send a GET request to each of the client in server&rsquo;s <code>client_ports</code> vector. This will call every client&rsquo;s <code>share_val</code> api and return their masked values. Then the server will sum up all the values to get the final aggregate value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>// Filter GET /aggregate
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Extract</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Rejection</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Clone</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with_server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>any</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;aggregate&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>warp</span>::<span style=color:#000>get</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>with_server</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>and_then</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handlers</span>::<span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>// Handler
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>aggregate_val</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server_async</span>: <span style=color:#000>Server_Async</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warp</span>::<span style=color:#000>Reply</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infallible</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server_async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>reqwest</span>::<span style=color:#000>Client</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aggregate_val</span>: <span style=color:#000>Wrapping</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>i</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>len</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http_client</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#4e9a06>&#34;http://localhost:{}/sharevalue&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>client_ports</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>masked_val</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>res</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>text</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u32</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>aggregate_val</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Wrapping</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>masked_val</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Response</span>::<span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>format!</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#4e9a06>&#34;Server Aggregate Result: {} \n&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>aggregate_val</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>Main</p>
<p>In server&rsquo;s main function, we initialize a new instance of <code>Server_Async</code> and pass it to all filters and handlers of the server. Similar to client, we will serve at localhost&rsquo;s (3000+N) port, where N is the input argument to the program.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#8f5902;font-style:italic>#[tokio::main]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>env</span>::<span style=color:#000>args</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>collect</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>println!</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;{:?}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>models</span>::<span style=color:#000>new_Server</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apis</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>filters</span>::<span style=color:#000>server_ops</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Let Server serve port (3000+N)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>warp</span>::<span style=color:#000>serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>apis</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>(([</span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>parse</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>u16</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unwrap</span><span style=color:#000;font-weight:700>()))</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ul>
<h3 id=demo>Demo</h3>
<p>Different from last two chapters, we will have to run multiple programs to test the correctness of our code.</p>
<ul>
<li>
<p><strong>Step 1: Create clients</strong></p>
<p>For convenience, let&rsquo;s just create 5 clients. Open five different terminals and run the following commands one by one, which will create 5 clients listening on localhost&rsquo;s port 3001, 3002, 3003, 3004, and 3005. Their actual values will also be printed in the terminal so you can sum them up by hand.</p>
<pre tabindex=0><code>cargo run --bin client 1
cargo run --bin client 2
cargo run --bin client 3
cargo run --bin client 4
cargo run --bin client 5
</code></pre></li>
<li>
<p><strong>Step 2: Create a server</strong></p>
<p>Then we are gonna need a server. Open another terminal and run the following command, which will create a server listening on port 3100.</p>
<pre tabindex=0><code>cargo run --bin server 100
</code></pre></li>
<li>
<p><strong>Step 3: Initialize and check the aggregate result</strong></p>
<p>We are gonna use curl to send http requests.</p>
<pre tabindex=0><code>curl -X PUT -H &quot;Content-Type: application/json&quot; -d '{&quot;port_list&quot;:[3001,3002,3003,3004,3005], &quot;num_collaborators&quot;:5}' http://localhost:3100/initialize

curl http://localhost:3100/aggregate
</code></pre><p>and you will see the result. Compare them to the sum of initial values, and we will see they are the same</p>
</li>
</ul>
<h3 id=full-code>Full Code</h3>
<p>View at <a href=https://github.com/camelop/dds-dev/tree/tutorial/chapter1.3>Github</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b8e75a52eff53776993479c317c1e4ff>4 - gRPC Service Specification</h1>
<div class=lead>Read the documentation for gRPC data types and service interfaces.</div>
<p><a name=top></a></p>
<h2 id=table-of-contents>Table of Contents</h2>
<ul>
<li>
<p><a href=#colink-proto>colink.proto</a></p>
<ul>
<li>
<p><a href=#colink-CoLinkInternalTaskIDList>CoLinkInternalTaskIDList</a></p>
</li>
<li>
<p><a href=#colink-CoLinkInternalTaskIDWithKeyPath>CoLinkInternalTaskIDWithKeyPath</a></p>
</li>
<li>
<p><a href=#colink-ConfirmTaskRequest>ConfirmTaskRequest</a></p>
</li>
<li>
<p><a href=#colink-CoreInfo>CoreInfo</a></p>
</li>
<li>
<p><a href=#colink-Decision>Decision</a></p>
</li>
<li>
<p><a href=#colink-Empty>Empty</a></p>
</li>
<li>
<p><a href=#colink-Jwt>Jwt</a></p>
</li>
<li>
<p><a href=#colink-MQQueueName>MQQueueName</a></p>
</li>
<li>
<p><a href=#colink-Participant>Participant</a></p>
</li>
<li>
<p><a href=#colink-ReadKeysRequest>ReadKeysRequest</a></p>
</li>
<li>
<p><a href=#colink-RefreshTokenRequest>RefreshTokenRequest</a></p>
</li>
<li>
<p><a href=#colink-StorageEntries>StorageEntries</a></p>
</li>
<li>
<p><a href=#colink-StorageEntry>StorageEntry</a></p>
</li>
<li>
<p><a href=#colink-SubscribeRequest>SubscribeRequest</a></p>
</li>
<li>
<p><a href=#colink-SubscriptionMessage>SubscriptionMessage</a></p>
</li>
<li>
<p><a href=#colink-Task>Task</a></p>
</li>
<li>
<p><a href=#colink-UserConsent>UserConsent</a></p>
</li>
<li>
<p><a href=#colink-CoLink>CoLink</a></p>
</li>
</ul>
</li>
<li>
<p><a href=#scalar-value-types>Scalar Value Types</a></p>
</li>
</ul>
<p><a name=colink-proto></a></p>
<p align=right><a href=#top>Top</a></p>
<h2 id=colinkproto>colink.proto</h2>
<p><a name=colink-CoLinkInternalTaskIDList></a></p>
<h3 id=colinkinternaltaskidlist>CoLinkInternalTaskIDList</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>task_ids_with_key_paths</td>
<td><a href=#colink-CoLinkInternalTaskIDWithKeyPath>CoLinkInternalTaskIDWithKeyPath</a></td>
<td>repeated</td>
<td></td>
</tr>
</tbody>
</table>
<p><a name=colink-CoLinkInternalTaskIDWithKeyPath></a></p>
<h3 id=colinkinternaltaskidwithkeypath>CoLinkInternalTaskIDWithKeyPath</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key_path</td>
<td><a href=#string>string</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td>task_id</td>
<td><a href=#string>string</a></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a name=colink-ConfirmTaskRequest></a></p>
<h3 id=confirmtaskrequest>ConfirmTaskRequest</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>task_id</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The id of this task.</td>
</tr>
<tr>
<td>decision</td>
<td><a href=#colink-Decision>Decision</a></td>
<td></td>
<td>The decision of this task.</td>
</tr>
</tbody>
</table>
<p><a name=colink-CoreInfo></a></p>
<h3 id=coreinfo>CoreInfo</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mq_uri</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The URI of MQ.</td>
</tr>
<tr>
<td>core_public_key</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The public key of the core, serialized in compact (default) form.</td>
</tr>
</tbody>
</table>
<p><a name=colink-Decision></a></p>
<h3 id=decision>Decision</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>is_approved</td>
<td><a href=#bool>bool</a></td>
<td></td>
<td>Approved / Rejected</td>
</tr>
<tr>
<td>is_rejected</td>
<td><a href=#bool>bool</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td>reason</td>
<td><a href=#string>string</a></td>
<td></td>
<td>Reason</td>
</tr>
<tr>
<td>signature</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>Signature</td>
</tr>
<tr>
<td>core_public_key</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>Core's public key</td>
</tr>
<tr>
<td>user_consent</td>
<td><a href=#colink-UserConsent>UserConsent</a></td>
<td></td>
<td>User consent</td>
</tr>
</tbody>
</table>
<p><a name=colink-Empty></a></p>
<h3 id=empty>Empty</h3>
<p><a name=colink-Jwt></a></p>
<h3 id=jwt>Jwt</h3>
<p>JSON Web Token (JWT) that is used to authenticate a user. The JWT the user's role, user_id - which is the base64 encoding of the public key - and the expiration time.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>jwt</td>
<td><a href=#string>string</a></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a name=colink-MQQueueName></a></p>
<h3 id=mqqueuename>MQQueueName</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>queue_name</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The name of the generated queue for this subscription.</td>
</tr>
</tbody>
</table>
<p><a name=colink-Participant></a></p>
<h3 id=participant>Participant</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_id</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The user id of this participant.</td>
</tr>
<tr>
<td>ptype</td>
<td><a href=#string>string</a></td>
<td></td>
<td>Type of this participant in the protocol.</td>
</tr>
</tbody>
</table>
<p><a name=colink-ReadKeysRequest></a></p>
<h3 id=readkeysrequest>ReadKeysRequest</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>prefix</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The prefix of the key_path of the entries to be retrieved.</td>
</tr>
<tr>
<td>include_history</td>
<td><a href=#bool>bool</a></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a name=colink-RefreshTokenRequest></a></p>
<h3 id=refreshtokenrequest>RefreshTokenRequest</h3>
<p>Contains the new expiration time to be set for the generated token.</p>
<p>The old token is contained in the header of this request, under the 'authorization' field.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>expiration_time</td>
<td><a href=#int64>int64</a></td>
<td></td>
<td>The new expiration time for the token, in unix timestamp format.</td>
</tr>
</tbody>
</table>
<p><a name=colink-StorageEntries></a></p>
<h3 id=storageentries>StorageEntries</h3>
<p>A list of entries.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>entries</td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td>repeated</td>
<td></td>
</tr>
</tbody>
</table>
<p><a name=colink-StorageEntry></a></p>
<h3 id=storageentry>StorageEntry</h3>
<p>An entry in the CoLink storage.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key_name</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The key name of the entry.</td>
</tr>
<tr>
<td>key_path</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The path of this entry. May contain information about the user_id, application_id, key name, and the timestamp of the entry. Note that, unlike other timestamps used in the protocol, the timestamp in the key_path is the number of <em>non-leap-nanoseconds</em> since January 1, 1970 UT, which is different from the unix timestamp.</td>
</tr>
<tr>
<td>payload</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The payload (value) of the entry.</td>
</tr>
</tbody>
</table>
<p><a name=colink-SubscribeRequest></a></p>
<h3 id=subscriberequest>SubscribeRequest</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key_name</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The key_name of the entry to be subscribed.</td>
</tr>
<tr>
<td>start_timestamp</td>
<td><a href=#int64>int64</a></td>
<td></td>
<td>start_timestamp, in the same format as the timestamp in the storage. Not in unix timestamp format.</td>
</tr>
</tbody>
</table>
<p><a name=colink-SubscriptionMessage></a></p>
<h3 id=subscriptionmessage>SubscriptionMessage</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>change_type</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The type of change of the storage entry. valid values: create/update/delete/in-storage.</td>
</tr>
<tr>
<td>key_path</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The key_path of the storage entry.</td>
</tr>
<tr>
<td>payload</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The payload (value) of the storage entry.</td>
</tr>
</tbody>
</table>
<p><a name=colink-Task></a></p>
<h3 id=task>Task</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>task_id</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The id of this task.</td>
</tr>
<tr>
<td>protocol_name</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The protocol of this task.</td>
</tr>
<tr>
<td>protocol_param</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The protocol parameters (after serialization).</td>
</tr>
<tr>
<td>participants</td>
<td><a href=#colink-Participant>Participant</a></td>
<td>repeated</td>
<td>The list of participants (initiator should be placed first).</td>
</tr>
<tr>
<td>parent_task</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The task id of the parent task.</td>
</tr>
<tr>
<td>require_agreement</td>
<td><a href=#bool>bool</a></td>
<td></td>
<td>Whether the task requires the signed decisions from all participants to start. If require_agreement=False, the task starts without confirming replies from others.</td>
</tr>
<tr>
<td>decisions</td>
<td><a href=#colink-Decision>Decision</a></td>
<td>repeated</td>
<td>The list of decisions (align with participants).</td>
</tr>
<tr>
<td>status</td>
<td><a href=#string>string</a></td>
<td></td>
<td>The status of this task.</td>
</tr>
<tr>
<td>expiration_time</td>
<td><a href=#int64>int64</a></td>
<td></td>
<td>The expiration time for waiting for others' decisions, in unix timestamp format.</td>
</tr>
</tbody>
</table>
<p><a name=colink-UserConsent></a></p>
<h3 id=userconsent>UserConsent</h3>
<p>Import a user from an existing public/secret key pair.</p>
<p>A signature by the user is required to verify the user's consent to let the core represent the user.</p>
<p>The signature message is the concatenation of user public key, timestamp at the time of signing, expiration timestamp, and core public key.
The signature will be saved in user's storage and get passed in inter-core communication, so other cores can ensure the core is representing the user by checking both public keys.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Label</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>public_key</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The public key of the user, serialized in compact (default) form.</td>
</tr>
<tr>
<td>signature_timestamp</td>
<td><a href=#int64>int64</a></td>
<td></td>
<td>Unix timestamp of time of signature, in unix timestamp format. The signature should be generated within 10 minutes of the time of signature verification</td>
</tr>
<tr>
<td>expiration_timestamp</td>
<td><a href=#int64>int64</a></td>
<td></td>
<td>The expiration timestamp for the token to be generated, and for the user consent, in unix timestamp format. We assume the JWT will have the same expiration time as the user consent.</td>
</tr>
<tr>
<td>signature</td>
<td><a href=#bytes>bytes</a></td>
<td></td>
<td>The ECDSA compact signature composed of user public key, timestamp at the time of signing, expiration timestamp, and core public key. The signature represents the user's consent to let the core represent the user by including the trusted core's public key.</td>
</tr>
</tbody>
</table>
<p><a name=colink-CoLink></a></p>
<h3 id=colink>CoLink</h3>
<table>
<thead>
<tr>
<th>Method Name</th>
<th>Request Type</th>
<th>Response Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RefreshToken</td>
<td><a href=#colink-RefreshTokenRequest>RefreshTokenRequest</a></td>
<td><a href=#colink-Jwt>Jwt</a></td>
<td>Given a valid JWT and a expiration timestamp, generates a new JWT token with the expiration time set to the input timestamp. Requires user jwt. You cannot refresh an admin token.</td>
</tr>
<tr>
<td>ImportUser</td>
<td><a href=#colink-UserConsent>UserConsent</a></td>
<td><a href=#colink-Jwt>Jwt</a></td>
<td>Generates a JWT from a user with a public/secret key pair. The generated JWT specifies the user's role as a user, contains their user_id, which is a base64 encoding of the provided public key. Requires admin Jwt.</td>
</tr>
<tr>
<td>CreateEntry</td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td>Creates an entry in CoLink storage. In the entry passed in to the call, the <code>key_name</code> field must be nonempty. Every other field is is ignored. Requires user or admin JWT. Returns a key_path with current timestamp included.</td>
</tr>
<tr>
<td>ReadEntries</td>
<td><a href=#colink-StorageEntries>StorageEntries</a></td>
<td><a href=#colink-StorageEntries>StorageEntries</a></td>
<td>Retrieves entries from CoLink storage. One and only one field among <code>key_name</code> and <code>key_path</code> is nonempty. If both are nonempty, an error is returned. If key_name is nonempty, returns the latest version of the entry with that key name. This is done by first obtaining the timestamp representing the latest version of the entry, and then retrieving the entry with that timestamp by including the timestamp in key_path. If key_path is nonempty, returns the entry with the corresponding key path. If you're looking for a specific version of an entry, use specify the timestamp inside the <code>key_path</code> field. In both cases, the key_name field is empty in the returned StorageEntry. key_path and payload are nonempty. If an entry is not found. An error is returned. Note that the returned order of the entries is NOT guaranteed to be the same as the order of the input. Requires user or admin JWT.</td>
</tr>
<tr>
<td>UpdateEntry</td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td>Updates an entry in CoLink storage. In the entry passed in to the call, the <code>key_name</code> field must be nonempty. Every other field is is ignored. Creates a new entry with the current timestamp in the key_path field. Sets the latest entry to current timestamp. Requires user or admin JWT. Returns a key_path with current timestamp included.</td>
</tr>
<tr>
<td>DeleteEntry</td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td><a href=#colink-StorageEntry>StorageEntry</a></td>
<td>Deletes an entry from CoLink storage. Sets the latest entry to current timestamp, but unlike UpdateEntry, we do not create a new entry with the current timestamp in the key_path field. Therefore the current timestamp points to nothing. Requires user or admin JWT. Returns a key_path with current timestamp included.</td>
</tr>
<tr>
<td>ReadKeys</td>
<td><a href=#colink-ReadKeysRequest>ReadKeysRequest</a></td>
<td><a href=#colink-StorageEntries>StorageEntries</a></td>
<td>Returns list of entries in CoLink storage whose key_path starts with input prefix. Requires user or admin JWT.</td>
</tr>
<tr>
<td>CreateTask</td>
<td><a href=#colink-Task>Task</a></td>
<td><a href=#colink-Task>Task</a></td>
<td>An initiator creates a task. Generate a task_id for this task. Represent user(initiator) to sign a decision for this task. Sync this task with other participants. Send task status to MQ. In request, protocol_name, protocol_param, participants are required. parent_task is optional. In response, only task_id will be included. Require user JWT.</td>
</tr>
<tr>
<td>ConfirmTask</td>
<td><a href=#colink-ConfirmTaskRequest>ConfirmTaskRequest</a></td>
<td><a href=#colink-Empty>Empty</a></td>
<td>A participant confirms a task. Represent user to sign a decision for this task. Sync the decision to the initiator. Send task status to MQ. The task will be ignored if is_approved and is_rejected are both false in the decision. In request, task_id is required. Require user JWT.</td>
</tr>
<tr>
<td>FinishTask</td>
<td><a href=#colink-Task>Task</a></td>
<td><a href=#colink-Empty>Empty</a></td>
<td>A participant finishes a task. Send task status to MQ. In request, task_id is required. Require user JWT.</td>
</tr>
<tr>
<td>RequestCoreInfo</td>
<td><a href=#colink-Empty>Empty</a></td>
<td><a href=#colink-CoreInfo>CoreInfo</a></td>
<td>Request the information of the core, including the URI of MQ, and the public key of the core. Return MQ Information optionally and core public key for this user. JWT is optional: when request includes jwt, the uri of mq will be returned.</td>
</tr>
<tr>
<td>Subscribe</td>
<td><a href=#colink-SubscribeRequest>SubscribeRequest</a></td>
<td><a href=#colink-MQQueueName>MQQueueName</a></td>
<td>Subscribe to changes in the storage. It will let you subscribe to all changes of key_name in storage since start_timestamp. The subscription message is formatted in SubscriptionMessage. Require user JWT.</td>
</tr>
<tr>
<td>Unsubscribe</td>
<td><a href=#colink-MQQueueName>MQQueueName</a></td>
<td><a href=#colink-Empty>Empty</a></td>
<td>Unsubscribe the changes in the storage. Require user JWT.</td>
</tr>
<tr>
<td>InterCoreSyncTask</td>
<td><a href=#colink-Task>Task</a></td>
<td><a href=#colink-Empty>Empty</a></td>
<td>InterCore RPC. Sync a task. If it receives a task with unknown task_id, then create this task in storage and send task status to MQ. Otherwise, update decisions in storage. If all participants' decisions are received and it is the initiator, sync the decisions to other participants. If all participants' decisions are received, send task status to MQ. The task status in the request should be ignored even if it exists.</td>
</tr>
</tbody>
</table>
<h2 id=scalar-value-types>Scalar Value Types</h2>
<table>
<thead>
<tr>
<th>.proto Type</th>
<th>Notes</th>
<th>C++</th>
<th>Java</th>
<th>Python</th>
<th>Go</th>
<th>C#</th>
<th>PHP</th>
<th>Ruby</th>
</tr>
</thead>
<tbody>
<tr>
<td><a name=double> double</td>
<td></td>
<td>double</td>
<td>double</td>
<td>float</td>
<td>float64</td>
<td>double</td>
<td>float</td>
<td>Float</td>
</tr>
<tr>
<td><a name=float> float</td>
<td></td>
<td>float</td>
<td>float</td>
<td>float</td>
<td>float32</td>
<td>float</td>
<td>float</td>
<td>Float</td>
</tr>
<tr>
<td><a name=int32> int32</td>
<td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint32 instead.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>int</td>
<td>integer</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=int64> int64</td>
<td>Uses variable-length encoding. Inefficient for encoding negative numbers – if your field is likely to have negative values, use sint64 instead.</td>
<td>int64</td>
<td>long</td>
<td>int/long</td>
<td>int64</td>
<td>long</td>
<td>integer/string</td>
<td>Bignum</td>
</tr>
<tr>
<td><a name=uint32> uint32</td>
<td>Uses variable-length encoding.</td>
<td>uint32</td>
<td>int</td>
<td>int/long</td>
<td>uint32</td>
<td>uint</td>
<td>integer</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=uint64> uint64</td>
<td>Uses variable-length encoding.</td>
<td>uint64</td>
<td>long</td>
<td>int/long</td>
<td>uint64</td>
<td>ulong</td>
<td>integer/string</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=sint32> sint32</td>
<td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int32s.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>int</td>
<td>integer</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=sint64> sint64</td>
<td>Uses variable-length encoding. Signed int value. These more efficiently encode negative numbers than regular int64s.</td>
<td>int64</td>
<td>long</td>
<td>int/long</td>
<td>int64</td>
<td>long</td>
<td>integer/string</td>
<td>Bignum</td>
</tr>
<tr>
<td><a name=fixed32> fixed32</td>
<td>Always four bytes. More efficient than uint32 if values are often greater than 2^28.</td>
<td>uint32</td>
<td>int</td>
<td>int</td>
<td>uint32</td>
<td>uint</td>
<td>integer</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=fixed64> fixed64</td>
<td>Always eight bytes. More efficient than uint64 if values are often greater than 2^56.</td>
<td>uint64</td>
<td>long</td>
<td>int/long</td>
<td>uint64</td>
<td>ulong</td>
<td>integer/string</td>
<td>Bignum</td>
</tr>
<tr>
<td><a name=sfixed32> sfixed32</td>
<td>Always four bytes.</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>int</td>
<td>integer</td>
<td>Bignum or Fixnum (as required)</td>
</tr>
<tr>
<td><a name=sfixed64> sfixed64</td>
<td>Always eight bytes.</td>
<td>int64</td>
<td>long</td>
<td>int/long</td>
<td>int64</td>
<td>long</td>
<td>integer/string</td>
<td>Bignum</td>
</tr>
<tr>
<td><a name=bool> bool</td>
<td></td>
<td>bool</td>
<td>boolean</td>
<td>boolean</td>
<td>bool</td>
<td>bool</td>
<td>boolean</td>
<td>TrueClass/FalseClass</td>
</tr>
<tr>
<td><a name=string> string</td>
<td>A string must always contain UTF-8 encoded or 7-bit ASCII text.</td>
<td>string</td>
<td>String</td>
<td>str/unicode</td>
<td>string</td>
<td>string</td>
<td>string</td>
<td>String (UTF-8)</td>
</tr>
<tr>
<td><a name=bytes> bytes</td>
<td>May contain any arbitrary sequence of bytes.</td>
<td>string</td>
<td>ByteString</td>
<td>str</td>
<td>[]byte</td>
<td>ByteString</td>
<td>string</td>
<td>String (ASCII-8BIT)</td>
</tr>
</tbody>
</table>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://example.org/mail aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel=noopener href=https://example.org/twitter aria-label=Twitter>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel=noopener href=https://example.org/stack aria-label="Stack Overflow">
<i class="fab fa-stack-overflow"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/google/docsy aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://example.org/slack aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://example.org/mail aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small>
<p class=mt-2><a href=/about/>About CoLearn</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.9527cedfef7fd2d44b9f7e019d1d3f20914d42e1280da7342a1a7facd3249a54.js integrity="sha256-lSfO3+9/0tRLn34BnR0/IJFNQuEoDac0Khp/rNMkmlQ=" crossorigin=anonymous></script>
</body>
</html>